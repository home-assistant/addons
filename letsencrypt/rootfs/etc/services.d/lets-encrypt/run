#!/usr/bin/with-contenv bashio
# vim: ft=bash
# shellcheck shell=bash
# ==============================================================================
# Start sshd service if enabled
# ==============================================================================
CERT_DIR=/data/letsencrypt
WORK_DIR=/data/workdir
DNS_API_KEY=/data/dnsapikey
DNS_MULTI_CREDS=/data/dns-multi.ini
ACME_ARGUMENTS=()
KEY_ARGUMENTS=()
EAB_ARGUMENTS=()
ADDITIONAL_ARGS=()

EMAIL=$(bashio::config 'email')
DOMAINS=$(bashio::config 'domains')
KEYFILE=$(bashio::config 'keyfile')
CERTFILE=$(bashio::config 'certfile')
CHALLENGE=$(bashio::config 'challenge')
DNS_PROVIDER=$(bashio::config 'dns.provider')
ACME_SERVER=$(bashio::config 'acme_server')
ACME_ROOT_CA_CERT=$(bashio::config 'acme_root_ca_cert')
EAB_KID=$(bashio::config 'eab_kid')
EAB_HMAC_KEY=$(bashio::config 'eab_hmac_key')
DRY_RUN=$(bashio::config 'dry_run')
TEST_CERT=$(bashio::config 'test_cert')
VERBOSE=$(bashio::config 'verbose')

# Legacy providers not supported by lego/certbot-dns-multi
LEGACY_PROVIDERS="dns-eurodns dns-gehirn dns-noris"

# Deprecated providers not having feature parity in lego/certbot-dns-multi
DEPRECATED_PROVIDERS="dns-azure dns-he"

if [ "${CHALLENGE}" == "dns" ]; then
    bashio::log.info "Selected DNS Provider: ${DNS_PROVIDER}"

    PROPAGATION_SECONDS=60
    if bashio::config.exists 'dns.propagation_seconds'; then
        PROPAGATION_SECONDS="$(bashio::config 'dns.propagation_seconds')"
    fi
    bashio::log.info "Use propagation seconds: ${PROPAGATION_SECONDS}"

    # Check if this is a legacy provider (not supported by dns-multi)
    # shellcheck disable=SC2076
    if [[ " ${LEGACY_PROVIDERS} " =~ " ${DNS_PROVIDER} " ]]; then
        bashio::log.info "Using dedicated certbot plugin for ${DNS_PROVIDER}"

        case "${DNS_PROVIDER}" in
            # Eurodns
            'dns-eurodns')
                bashio::config.require 'dns.eurodns_applicationId'
                bashio::config.require 'dns.eurodns_apiKey'

                echo -e "dns_eurodns_apiKey = $(bashio::config 'dns.eurodns_apiKey')\n" \
                      "dns_eurodns_applicationId = $(bashio::config 'dns.eurodns_applicationId')\n" > "${DNS_API_KEY}"

                ACME_ARGUMENTS+=("--authenticator" "${DNS_PROVIDER}" "--${DNS_PROVIDER}-credentials" "${DNS_API_KEY}" "--${DNS_PROVIDER}-propagation-seconds" "${PROPAGATION_SECONDS}")
                ;;

            # Gehirn
            'dns-gehirn')
                bashio::config.require 'dns.gehirn_api_token'
                bashio::config.require 'dns.gehirn_api_secret'

                echo -e "dns_gehirn_api_secret = $(bashio::config 'dns.gehirn_api_secret')\n" \
                      "dns_gehirn_api_token = $(bashio::config 'dns.gehirn_api_token')" > "${DNS_API_KEY}"

                ACME_ARGUMENTS+=("--${DNS_PROVIDER}" "--${DNS_PROVIDER}-credentials" "${DNS_API_KEY}")
                ;;

            # noris network
            'dns-noris')
                bashio::config.require 'dns.noris_token'

                echo "dns_noris_token = $(bashio::config 'dns.noris_token')" > "${DNS_API_KEY}"

                ACME_ARGUMENTS+=("--authenticator" "${DNS_PROVIDER}" "--${DNS_PROVIDER}-credentials" "${DNS_API_KEY}" "--${DNS_PROVIDER}-propagation-seconds" "${PROPAGATION_SECONDS}")
                ;;
        esac
    elif [[ " ${DEPRECATED_PROVIDERS} " =~ " ${DNS_PROVIDER} " ]]; then
        bashio::log.warning "Using deprecated certbot plugin for ${DNS_PROVIDER}"

        case "${DNS_PROVIDER}" in
            # Azure
            'dns-azure')
                bashio::log.warning "The dns-azure provider is deprecated, please migrate to certbot-dns-multi configuration"

                # File is copied during container init by file-structure.sh
                ACME_ARGUMENTS+=("--authenticator" "dns-azure" "--dns-azure-config" "/data/azure_creds" "--dns-azure-propagation-seconds" "${PROPAGATION_SECONDS}")
                ;;
            # Hurricane Electric DNS
            'dns-he')
                bashio::log.warning "The dns-he provider is deprecated, please migrate to certbot-dns-multi configuration"

                bashio::config.require 'dns.he_user'
                bashio::config.require 'dns.he_pass'

                echo -e "dns_hurricane_electric_pass = $(bashio::config 'dns.he_pass')\n" \
                      "dns_hurricane_electric_user = $(bashio::config 'dns.he_user')" > "${DNS_API_KEY}"

                ACME_ARGUMENTS+=("--authenticator" "dns-hurricane_electric" "--dns-hurricane_electric-credentials" "/data/dnsapikey" "--dns-hurricane_electric-propagation-seconds" "${PROPAGATION_SECONDS}")
                ;;
        esac
    else
        # Use certbot-dns-multi for all other providers
        bashio::log.info "Using certbot-dns-multi for ${DNS_PROVIDER}"

        # Map config provider names to lego provider names
        declare -A LEGO_PROVIDERS=(
            ["dns-cloudflare"]="cloudflare"
            ["dns-cloudns"]="cloudns"
            ["dns-desec"]="desec"
            ["dns-digitalocean"]="digitalocean"
            ["dns-directadmin"]="directadmin"
            ["dns-dnsimple"]="dnsimple"
            ["dns-dnsmadeeasy"]="dnsmadeeasy"
            ["dns-domainoffensive"]="dode"
            ["dns-dreamhost"]="dreamhost"
            ["dns-duckdns"]="duckdns"
            ["dns-dynu"]="dynu"
            ["dns-easydns"]="easydns"
            ["dns-gandi"]="gandiv5"
            ["dns-godaddy"]="godaddy"
            ["dns-google"]="gcloud"
            ["dns-hetzner"]="hetzner"
            ["dns-infomaniak"]="infomaniak"
            ["dns-inwx"]="inwx"
            ["dns-ionos"]="ionos"
            ["dns-joker"]="joker"
            ["dns-linode"]="linode"
            ["dns-loopia"]="loopia"
            ["dns-luadns"]="luadns"
            ["dns-mijn-host"]="mijnhost"
            ["dns-namecheap"]="namecheap"
            ["dns-netcup"]="netcup"
            ["dns-njalla"]="njalla"
            ["dns-nsone"]="ns1"
            ["dns-ovh"]="ovh"
            ["dns-plesk"]="plesk"
            ["dns-porkbun"]="porkbun"
            ["dns-rfc2136"]="rfc2136"
            ["dns-route53"]="route53"
            ["dns-sakuracloud"]="sakuracloud"
            ["dns-simply"]="simply"
            ["dns-transip"]="transip"
            ["dns-websupport"]="websupport"
        )

        # All other providers use dns-multi
        LEGO_PROVIDER="${LEGO_PROVIDERS[$DNS_PROVIDER]-}"
        if [ -z "${LEGO_PROVIDER}" ]; then
            LEGO_PROVIDER="$(bashio::config 'dns.lego_provider')"
            if [ -n "${LEGO_PROVIDER}" ]; then
                bashio::log.info "Using custom lego provider from config: ${LEGO_PROVIDER}"
            else
              bashio::log.error "Unknown DNS provider: ${DNS_PROVIDER}"
              exit 1
            fi
        fi

        # Start building the dns-multi credentials file
        echo "# generated by letsencrypt app startup script" > "${DNS_MULTI_CREDS}"
        echo "dns_multi_provider = ${LEGO_PROVIDER}" >> "${DNS_MULTI_CREDS}"

        # Provider-specific credential mapping to lego environment variables
        case "${DNS_PROVIDER}" in
        'dns-lego')
            bashio::config.require 'dns.lego_provider'

            # Add custom environment variables for lego provider
            if bashio::config.has_value 'dns.lego_env'; then
                LEGO_ENV_COUNT=$(bashio::config 'dns.lego_env | length')
                for (( i=0; i < LEGO_ENV_COUNT; i++ )); do
                    env_entry="$(bashio::config "dns.lego_env[${i}]")"
                    if [[ "${env_entry}" != *"="* ]]; then
                        bashio::log.error "Invalid lego_env entry (must be KEY=VALUE): ${env_entry}"
                        exit 1
                    fi
                    echo "${env_entry}" >> "${DNS_MULTI_CREDS}"
                done
            else
                bashio::log.error "dns.lego_env must be configured for dns-lego provider"
                exit 1
            fi
            ;;
        # CloudFlare
        'dns-cloudflare')
            if bashio::config.exists 'dns.cloudflare_api_token'; then
                bashio::log.info "Using CloudFlare token"
                echo "CLOUDFLARE_DNS_API_TOKEN=$(bashio::config 'dns.cloudflare_api_token')" >> "${DNS_MULTI_CREDS}"
            else
                bashio::log.warning "Using CloudFlare global key (not recommended!)"
                echo "CF_API_EMAIL=$(bashio::config 'dns.cloudflare_email')" >> "${DNS_MULTI_CREDS}"
                echo "CF_API_KEY=$(bashio::config 'dns.cloudflare_api_key')" >> "${DNS_MULTI_CREDS}"
            fi
            ;;

        # ClouDNS
        'dns-cloudns')
            bashio::config.require 'dns.cloudns_auth_password'
            echo "CLOUDNS_AUTH_PASSWORD=$(bashio::config 'dns.cloudns_auth_password')" >> "${DNS_MULTI_CREDS}"
            if bashio::config.exists 'dns.cloudns_auth_id'; then
                echo "CLOUDNS_AUTH_ID=$(bashio::config 'dns.cloudns_auth_id')" >> "${DNS_MULTI_CREDS}"
            fi
            if bashio::config.exists 'dns.cloudns_sub_auth_id'; then
                echo "CLOUDNS_SUB_AUTH_ID=$(bashio::config 'dns.cloudns_sub_auth_id')" >> "${DNS_MULTI_CREDS}"
            fi
            ;;

        # deSEC.io
        'dns-desec')
            bashio::config.require 'dns.desec_token'
            echo "DESEC_TOKEN=$(bashio::config 'dns.desec_token')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Digital Ocean
        'dns-digitalocean')
            bashio::config.require 'dns.digitalocean_token'
            echo "DO_AUTH_TOKEN=$(bashio::config 'dns.digitalocean_token')" >> "${DNS_MULTI_CREDS}"
            # Uppercased provider name differs from variable prefix, set propagation timeout here
            echo "DO_PROPAGATION_TIMEOUT=${PROPAGATION_SECONDS}" >> "${DNS_MULTI_CREDS}"
            PROPAGATION_SECONDS=""
            ;;

        # DirectAdmin
        'dns-directadmin')
            bashio::config.require 'dns.directadmin_url'
            bashio::config.require 'dns.directadmin_username'
            bashio::config.require 'dns.directadmin_password'
            echo "DIRECTADMIN_API_URL=$(bashio::config 'dns.directadmin_url')" >> "${DNS_MULTI_CREDS}"
            echo "DIRECTADMIN_USERNAME=$(bashio::config 'dns.directadmin_username')" >> "${DNS_MULTI_CREDS}"
            echo "DIRECTADMIN_PASSWORD=$(bashio::config 'dns.directadmin_password')" >> "${DNS_MULTI_CREDS}"
            ;;

        # DNSimple
        'dns-dnsimple')
            bashio::config.require 'dns.dnsimple_token'
            echo "DNSIMPLE_OAUTH_TOKEN=$(bashio::config 'dns.dnsimple_token')" >> "${DNS_MULTI_CREDS}"
            ;;

        # DNS Made Easy
        'dns-dnsmadeeasy')
            bashio::config.require 'dns.dnsmadeeasy_api_key'
            bashio::config.require 'dns.dnsmadeeasy_secret_key'
            echo "DNSMADEEASY_API_KEY=$(bashio::config 'dns.dnsmadeeasy_api_key')" >> "${DNS_MULTI_CREDS}"
            echo "DNSMADEEASY_API_SECRET=$(bashio::config 'dns.dnsmadeeasy_secret_key')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Domain Offensive (do.de)
        'dns-domainoffensive')
            bashio::config.require 'dns.domainoffensive_token'
            echo "DODE_TOKEN=$(bashio::config 'dns.domainoffensive_token')" >> "${DNS_MULTI_CREDS}"
            ;;

        # DreamHost
        'dns-dreamhost')
            bashio::config.require 'dns.dreamhost_api_key'
            echo "DREAMHOST_API_KEY=$(bashio::config 'dns.dreamhost_api_key')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Duck DNS
        'dns-duckdns')
            bashio::config.require 'dns.duckdns_token'
            echo "DUCKDNS_TOKEN=$(bashio::config 'dns.duckdns_token')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Dynu
        'dns-dynu')
            bashio::config.require 'dns.dynu_auth_token'
            echo "DYNU_API_KEY=$(bashio::config 'dns.dynu_auth_token')" >> "${DNS_MULTI_CREDS}"
            ;;

        # EasyDNS
        'dns-easydns')
            bashio::config.require 'dns.easydns_key'
            bashio::config.require 'dns.easydns_token'
            echo "EASYDNS_KEY=$(bashio::config 'dns.easydns_key')" >> "${DNS_MULTI_CREDS}"
            echo "EASYDNS_TOKEN=$(bashio::config 'dns.easydns_token')" >> "${DNS_MULTI_CREDS}"
            if bashio::config.exists 'dns.easydns_endpoint'; then
                echo "EASYDNS_ENDPOINT=$(bashio::config 'dns.easydns_endpoint')" >> "${DNS_MULTI_CREDS}"
            fi
            ;;

        # Gandi Live DNS (v5)
        'dns-gandi')
            if bashio::config.exists 'dns.gandi_token'; then
                bashio::log.warning "Using Gandi personal access token (deprecated)"
                echo "GANDIV5_PERSONAL_ACCESS_TOKEN=$(bashio::config 'dns.gandi_token')" >> "${DNS_MULTI_CREDS}"
            elif bashio::config.exists 'dns.gandi_api_key'; then
                bashio::log.info "Using Gandi API key"
                echo "GANDIV5_API_KEY=$(bashio::config 'dns.gandi_api_key')" >> "${DNS_MULTI_CREDS}"
            fi
            ;;

        # Go Daddy
        'dns-godaddy')
            bashio::config.require 'dns.godaddy_key'
            bashio::config.require 'dns.godaddy_secret'
            echo "GODADDY_API_KEY=$(bashio::config 'dns.godaddy_key')" >> "${DNS_MULTI_CREDS}"
            echo "GODADDY_API_SECRET=$(bashio::config 'dns.godaddy_secret')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Google Cloud
        'dns-google')
            bashio::config.require 'dns.google_creds'
            # File is copied during container init by file-structure.sh
            echo "GCE_SERVICE_ACCOUNT_FILE=/data/google.json" >> "${DNS_MULTI_CREDS}"
            # Uppercased provider name differs from variable prefix, set propagation timeout here
            echo "GCE_PROPAGATION_TIMEOUT=${PROPAGATION_SECONDS}" >> "${DNS_MULTI_CREDS}"
            PROPAGATION_SECONDS=""
            ;;

        # Hetzner
        'dns-hetzner')
            bashio::config.require 'dns.hetzner_api_token'
            echo "HETZNER_API_TOKEN=$(bashio::config 'dns.hetzner_api_token')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Infomaniak
        'dns-infomaniak')
            bashio::config.require 'dns.infomaniak_api_token'
            echo "INFOMANIAK_ACCESS_TOKEN=$(bashio::config 'dns.infomaniak_api_token')" >> "${DNS_MULTI_CREDS}"
            ;;

        # INWX
        'dns-inwx')
            bashio::config.require 'dns.inwx_username'
            bashio::config.require 'dns.inwx_password'
            echo "INWX_USERNAME=$(bashio::config 'dns.inwx_username')" >> "${DNS_MULTI_CREDS}"
            echo "INWX_PASSWORD=$(bashio::config 'dns.inwx_password')" >> "${DNS_MULTI_CREDS}"
            if bashio::config.exists 'dns.inwx_shared_secret'; then
                echo "INWX_SHARED_SECRET=$(bashio::config 'dns.inwx_shared_secret')" >> "${DNS_MULTI_CREDS}"
            fi
            ;;

        # IONOS
        'dns-ionos')
            bashio::config.require 'dns.ionos_prefix'
            bashio::config.require 'dns.ionos_secret'
            # IONOS API key format is prefix.secret
            echo "IONOS_API_KEY=$(bashio::config 'dns.ionos_prefix').$(bashio::config 'dns.ionos_secret')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Joker
        'dns-joker')
            bashio::config.require 'dns.joker_username'
            bashio::config.require 'dns.joker_password'
            echo "JOKER_USERNAME=$(bashio::config 'dns.joker_username')" >> "${DNS_MULTI_CREDS}"
            echo "JOKER_PASSWORD=$(bashio::config 'dns.joker_password')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Linode (v4)
        'dns-linode')
            bashio::config.require 'dns.linode_key'
            echo "LINODE_TOKEN=$(bashio::config 'dns.linode_key')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Loopia
        'dns-loopia')
            bashio::config.require 'dns.loopia_user'
            bashio::config.require 'dns.loopia_password'
            if (( PROPAGATION_SECONDS < 900 )); then
                bashio::log.info "Increasing DNS propagation limit for Loopia to at least 900 seconds due to caching issues."
                PROPAGATION_SECONDS=900
            fi
            echo "LOOPIA_API_USER=$(bashio::config 'dns.loopia_user')" >> "${DNS_MULTI_CREDS}"
            echo "LOOPIA_API_PASSWORD=$(bashio::config 'dns.loopia_password')" >> "${DNS_MULTI_CREDS}"
            ;;

        # LuaDNS
        'dns-luadns')
            bashio::config.require 'dns.luadns_email'
            bashio::config.require 'dns.luadns_token'
            echo "LUADNS_API_USERNAME=$(bashio::config 'dns.luadns_email')" >> "${DNS_MULTI_CREDS}"
            echo "LUADNS_API_TOKEN=$(bashio::config 'dns.luadns_token')" >> "${DNS_MULTI_CREDS}"
            ;;

        # mijn.host
        'dns-mijn-host')
            bashio::config.require 'dns.mijn_host_api_key'
            echo "MIJNHOST_API_KEY=$(bashio::config 'dns.mijn_host_api_key')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Namecheap
        'dns-namecheap')
            bashio::config.require 'dns.namecheap_username'
            bashio::config.require 'dns.namecheap_api_key'
            echo "NAMECHEAP_API_USER=$(bashio::config 'dns.namecheap_username')" >> "${DNS_MULTI_CREDS}"
            echo "NAMECHEAP_API_KEY=$(bashio::config 'dns.namecheap_api_key')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Netcup
        'dns-netcup')
            bashio::config.require 'dns.netcup_customer_id'
            bashio::config.require 'dns.netcup_api_key'
            bashio::config.require 'dns.netcup_api_password'
            echo "NETCUP_CUSTOMER_NUMBER=$(bashio::config 'dns.netcup_customer_id')" >> "${DNS_MULTI_CREDS}"
            echo "NETCUP_API_KEY=$(bashio::config 'dns.netcup_api_key')" >> "${DNS_MULTI_CREDS}"
            echo "NETCUP_API_PASSWORD=$(bashio::config 'dns.netcup_api_password')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Njalla
        'dns-njalla')
            bashio::config.require 'dns.njalla_token'
            echo "NJALLA_TOKEN=$(bashio::config 'dns.njalla_token')" >> "${DNS_MULTI_CREDS}"
            ;;

        # NS1
        'dns-nsone')
            bashio::config.require 'dns.nsone_api_key'
            echo "NS1_API_KEY=$(bashio::config 'dns.nsone_api_key')" >> "${DNS_MULTI_CREDS}"
            ;;

        # OVH
        'dns-ovh')
            bashio::config.require 'dns.ovh_application_key'
            bashio::config.require 'dns.ovh_application_secret'
            bashio::config.require 'dns.ovh_consumer_key'
            bashio::config.require 'dns.ovh_endpoint'
            echo "OVH_APPLICATION_KEY=$(bashio::config 'dns.ovh_application_key')" >> "${DNS_MULTI_CREDS}"
            echo "OVH_APPLICATION_SECRET=$(bashio::config 'dns.ovh_application_secret')" >> "${DNS_MULTI_CREDS}"
            echo "OVH_CONSUMER_KEY=$(bashio::config 'dns.ovh_consumer_key')" >> "${DNS_MULTI_CREDS}"
            echo "OVH_ENDPOINT=$(bashio::config 'dns.ovh_endpoint')" >> "${DNS_MULTI_CREDS}"
            ;;

        # plesk.com
        'dns-plesk')
            bashio::config.require 'dns.plesk_username'
            bashio::config.require 'dns.plesk_password'
            bashio::config.require 'dns.plesk_api_url'
            if (( PROPAGATION_SECONDS < 120 )); then
                bashio::log.info "Increasing DNS propagation limit for Plesk to at least 120 seconds."
                PROPAGATION_SECONDS=120
            fi
            echo "PLESK_SERVER_BASE_URL=$(bashio::config 'dns.plesk_api_url')" >> "${DNS_MULTI_CREDS}"
            echo "PLESK_USERNAME=$(bashio::config 'dns.plesk_username')" >> "${DNS_MULTI_CREDS}"
            echo "PLESK_PASSWORD=$(bashio::config 'dns.plesk_password')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Porkbun
        'dns-porkbun')
            bashio::config.require 'dns.porkbun_key'
            bashio::config.require 'dns.porkbun_secret'
            echo "PORKBUN_API_KEY=$(bashio::config 'dns.porkbun_key')" >> "${DNS_MULTI_CREDS}"
            echo "PORKBUN_SECRET_API_KEY=$(bashio::config 'dns.porkbun_secret')" >> "${DNS_MULTI_CREDS}"
            ;;

        # RFC2136
        'dns-rfc2136')
            bashio::config.require 'dns.rfc2136_server'
            bashio::config.require 'dns.rfc2136_name'
            bashio::config.require 'dns.rfc2136_secret'
            RFC2136_PORT=$(bashio::config 'dns.rfc2136_port')
            if [ -n "${RFC2136_PORT}" ]; then
                echo "RFC2136_NAMESERVER=$(bashio::config 'dns.rfc2136_server'):${RFC2136_PORT}" >> "${DNS_MULTI_CREDS}"
            else
                echo "RFC2136_NAMESERVER=$(bashio::config 'dns.rfc2136_server')" >> "${DNS_MULTI_CREDS}"
            fi
            echo "RFC2136_TSIG_KEY=$(bashio::config 'dns.rfc2136_name')" >> "${DNS_MULTI_CREDS}"
            echo "RFC2136_TSIG_SECRET=$(bashio::config 'dns.rfc2136_secret')" >> "${DNS_MULTI_CREDS}"
            if bashio::config.exists 'dns.rfc2136_algorithm'; then
                echo "RFC2136_TSIG_ALGORITHM=$(bashio::config 'dns.rfc2136_algorithm')" >> "${DNS_MULTI_CREDS}"
            fi
            ;;

        # Amazon Route 53
        'dns-route53')
            bashio::config.require 'dns.aws_access_key_id'
            bashio::config.require 'dns.aws_secret_access_key'
            echo "AWS_ACCESS_KEY_ID=$(bashio::config 'dns.aws_access_key_id')" >> "${DNS_MULTI_CREDS}"
            echo "AWS_SECRET_ACCESS_KEY=$(bashio::config 'dns.aws_secret_access_key')" >> "${DNS_MULTI_CREDS}"
            # Uppercased provider name differs from variable prefix, set propagation timeout here
            echo "AWS_PROPAGATION_TIMEOUT=${PROPAGATION_SECONDS}" >> "${DNS_MULTI_CREDS}"
            PROPAGATION_SECONDS=""
            ;;

        # SakuraCloud
        'dns-sakuracloud')
            bashio::config.require 'dns.sakuracloud_api_token'
            bashio::config.require 'dns.sakuracloud_api_secret'
            echo "SAKURACLOUD_ACCESS_TOKEN=$(bashio::config 'dns.sakuracloud_api_token')" >> "${DNS_MULTI_CREDS}"
            echo "SAKURACLOUD_ACCESS_TOKEN_SECRET=$(bashio::config 'dns.sakuracloud_api_secret')" >> "${DNS_MULTI_CREDS}"
            ;;

        # Simply.com
        'dns-simply')
            bashio::config.require 'dns.simply_account_name'
            bashio::config.require 'dns.simply_api_key'
            echo "SIMPLY_ACCOUNT_NAME=$(bashio::config 'dns.simply_account_name')" >> "${DNS_MULTI_CREDS}"
            echo "SIMPLY_API_KEY=$(bashio::config 'dns.simply_api_key')" >> "${DNS_MULTI_CREDS}"
            ;;

        # TransIP
        'dns-transip')
            bashio::config.require 'dns.transip_username'
            bashio::config.require 'dns.transip_api_key'

            echo "TRANSIP_ACCOUNT_NAME=$(bashio::config 'dns.transip_username')" >> "${DNS_MULTI_CREDS}"
            ## Prepare TransIP RSA key
            TRANSIP_RSA_KEY=/data/transip-rsa.key
            touch "${TRANSIP_RSA_KEY}"
            chmod 0600 "${TRANSIP_RSA_KEY}"
            if ! bashio::config 'dns.transip_api_key' | openssl rsa -out "${TRANSIP_RSA_KEY}" 2>/dev/null; then
                bashio::log.error "Failed to process TransIP API RSA key. Ensure 'dns.transip_api_key' contains a valid RSA private key."
                exit 1
            fi
            echo "TRANSIP_PRIVATE_KEY_PATH=${TRANSIP_RSA_KEY}" >> "${DNS_MULTI_CREDS}"

            if (( PROPAGATION_SECONDS < 240 )); then
                bashio::log.info "Increasing DNS propagation time for TransIP to at least 240 seconds."
                PROPAGATION_SECONDS=240
            fi
            ;;

        # WebSupport
        'dns-websupport')
            bashio::config.require 'dns.websupport_identifier'
            bashio::config.require 'dns.websupport_secret_key'
            echo "WEBSUPPORT_API_KEY=$(bashio::config 'dns.websupport_identifier')" >> "${DNS_MULTI_CREDS}"
            echo "WEBSUPPORT_SECRET=$(bashio::config 'dns.websupport_secret_key')" >> "${DNS_MULTI_CREDS}"
            ;;
        esac

        if [ -n "${PROPAGATION_SECONDS}" ]; then
            PROVIDER_UPPER=$(echo "${LEGO_PROVIDER}" | tr '[:lower:]' '[:upper:]')
            echo "${PROVIDER_UPPER}_PROPAGATION_TIMEOUT=${PROPAGATION_SECONDS}" >> "${DNS_MULTI_CREDS}"
        fi

        ACME_ARGUMENTS+=("--authenticator" "dns-multi" "--dns-multi-credentials" "${DNS_MULTI_CREDS}")
    fi
else
    bashio::log.info "Selected HTTP verification"
    ACME_ARGUMENTS+=("--standalone")
fi

if bashio::config.has_value 'acme_server'; then
    ACME_ARGUMENTS+=("--server" "${ACME_SERVER}")
    if bashio::config.has_value 'acme_root_ca_cert'; then
        bashio::log.info "Updating the trust store by adding the provided custom root certificate"
        # Address potential header and footer errors from YAML mutiline configuration.
        # Check the certificate and import it in the local trust store.
        # Certbot relies on the Requests Python library, which uses a built-in
        # trust store. This is replaced by the updated local trust store.
        echo "${ACME_ROOT_CA_CERT}" \
          | sed 's/----- /-----\n/g' | sed 's/ -----/\n-----/g' \
          | openssl x509  > /usr/local/share/ca-certificates/acme_root_ca.crt \
          && update-ca-certificates --fresh \
          && export REQUESTS_CA_BUNDLE=/etc/ssl/cert.pem
    fi
else
    # Relevant only for default Let's Encrypt servers.
    ACME_ARGUMENTS+=(--preferred-chain 'ISRG Root X1')
    if [ "${DRY_RUN}" = "true" ]; then
        ADDITIONAL_ARGS+=("--dry-run")
    fi
    if [ "${TEST_CERT}" = "true" ]; then
        ADDITIONAL_ARGS+=("--test-cert")
    fi
fi

if [ "${VERBOSE}" = "true" ]; then
    ADDITIONAL_ARGS+=("-vvv")
fi

# Gather all domains into a plaintext file
DOMAIN_ARR=()
for line in $DOMAINS; do
    DOMAIN_ARR+=(-d "$line")
done
echo "$DOMAINS" > /data/domains.gen

# Key detection or manual ECDSA/RSA selection
if bashio::config.exists 'key_type'; then
    # Use key type set in configuration
    KEY_TYPE=$(bashio::config 'key_type')
    KEY_ARGUMENTS+=("--key-type" "${KEY_TYPE}")
    if [ "${KEY_TYPE}" == "ecdsa" ]; then
        if bashio::config.exists 'elliptic_curve'; then
            ELLIPTIC_CURVE=$(bashio::config 'elliptic_curve')
            KEY_ARGUMENTS+=("--elliptic-curve" "${ELLIPTIC_CURVE}")
        else
            KEY_ARGUMENTS+=("--elliptic-curve" "secp384r1")
        fi
    fi
else
    bashio::log.info "Detecting existing certificate type for ${DOMAIN_ARR[1]}"
    readarray -t CBCERTS < <(certbot certificates --non-interactive --cert-name "${DOMAIN_ARR[1]}" --config-dir "$CERT_DIR" --work-dir "$WORK_DIR")
    for output in "${CBCERTS[@]}"; do
        # shellcheck disable=SC2076
        if [[ $output =~ "No certificates found." ]]; then
            bashio::log.info "No certificate found - using 'ecdsa' key type."
            KEY_ARGUMENTS+=("--key-type" "ecdsa")
            break
        fi
        if [[ $output =~ "Key Type: RSA" ]]; then
            bashio::log.info "Existing certificate using 'rsa' key type."
            KEY_ARGUMENTS+=("--key-type" "rsa")
            break
        fi
        if [[ $output =~ "Key Type: ECDSA" ]]; then
            bashio::log.info "Existing certificate using 'ecdsa' key type."
            KEY_ARGUMENTS+=("--key-type" "ecdsa")
            break
        fi
    done
fi

# Set External Account Binding
if bashio::config.has_value 'eab_kid' ; then
    bashio::config.require 'eab_hmac_key'
    EAB_ARGUMENTS+=("--eab-kid" "${EAB_KID}" "--eab-hmac-key" "${EAB_HMAC_KEY}")
fi

# Generate a new certificate if necessary or expand a previous certificate if domains has changed
certbot certonly --non-interactive --keep-until-expiring --expand \
    --email "$EMAIL" --agree-tos \
    "${KEY_ARGUMENTS[@]}" \
    "${ADDITIONAL_ARGS[@]}" \
    --cert-name "${DOMAIN_ARR[1]}" "${DOMAIN_ARR[@]}" \
    --config-dir "$CERT_DIR" --work-dir "$WORK_DIR" \
    --preferred-challenges "$CHALLENGE" \
    "${ACME_ARGUMENTS[@]}" \
    "${EAB_ARGUMENTS[@]}"

# Get the last modified cert directory and copy the cert and private key to store
# shellcheck disable=SC2012
CERT_DIR_LATEST="$(ls -td $CERT_DIR/live/*/ | head -1)"
cp "${CERT_DIR_LATEST}privkey.pem" "/ssl/$KEYFILE"
cp "${CERT_DIR_LATEST}fullchain.pem" "/ssl/$CERTFILE"
