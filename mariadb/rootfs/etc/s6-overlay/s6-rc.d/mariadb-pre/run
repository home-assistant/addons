#!/command/with-contenv bashio
# shellcheck shell=bash
# ==============================================================================
# Pre-start initialization of MariaDB service
# ==============================================================================
MARIADB_DATA=/data/databases
NEW_INSTALL=false

if ! bashio::fs.directory_exists "${MARIADB_DATA}"; then
    NEW_INSTALL=true
fi

# Redirect log output
mkdir -p "${MARIADB_DATA}"
rm -f "${MARIADB_DATA}/mariadb.err"
ln -s /proc/1/fd/1 "${MARIADB_DATA}/mariadb.err"

# Init mariadb
if bashio::var.true "${NEW_INSTALL}"; then
    bashio::log.info "Create a new mariadb initial system"
    mysql_install_db --user=root --datadir="${MARIADB_DATA}" --skip-name-resolve --skip-test-db > /dev/null
else
    bashio::log.info "Using existing mariadb initial system"
fi

# Save variables
echo "${NEW_INSTALL}" > /run/NEW_INSTALL
